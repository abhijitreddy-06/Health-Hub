<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctor Video Call | TeleHealth</title>

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #38bdf8;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ===== HEADER ===== */
        header {
            background: #020617;
            padding: 1rem 4%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        /* ===== VIDEO AREA ===== */
        .call-container {
            flex: 1;
            position: relative;
            display: flex;
            background: black;
        }

        video {
            object-fit: cover;
            border-radius: 10px;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
        }

        #localVideo {
            position: absolute;
            bottom: 90px;
            right: 20px;
            width: 220px;
            height: 140px;
            border: 2px solid var(--primary);
            background: black;
            z-index: 10;
        }

        /* ===== CONTROLS ===== */
        .controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            background: rgba(2, 6, 23, 0.9);
            padding: 12px 20px;
            border-radius: 30px;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--card);
            color: white;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .control-btn.end {
            background: #ef4444;
        }

        /* ===== CHAT PLACEHOLDER ===== */
        .chat-panel {
            width: 300px;
            background: #020617;
            padding: 1rem;
            display: none;
            /* future feature */
        }

        /* ===== FOOTER ===== */
        footer {
            background: #020617;
            text-align: center;
            padding: 0.6rem;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        @media (max-width: 768px) {
            #localVideo {
                width: 160px;
                height: 110px;
            }
        }
        .end-btn {
  background: #ef4444;
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  margin-left: 10px;
}
    </style>
</head>

<body>

    <!-- HEADER -->
    <header>
        <a href="/doc_home" class="logo">TeleHealth</a>
        <span>Doctor Video Call</span>
    </header>

    <!-- VIDEO CALL -->
    <div class="call-container">

        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay muted playsinline></video>

        <!-- CONTROLS -->
        <div class="controls">
            <button class="control-btn" id="toggleMic">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="control-btn" id="toggleCam">
                <i class="fas fa-video"></i>
            </button>
<button id="endCallBtn">End Call</button>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>Â© 2025 TeleHealth</footer>

<script src="/socket.io/socket.io.js"></script>
<script>
    document.getElementById("endCallBtn").onclick = async () => {
        // notify user
        socket.emit("call-ended", { roomId });

        // ðŸ”´ THIS was missing
        await fetch(`/appointments/${APPOINTMENT_ID}/complete`, {
            method: "POST"
        });

        cleanupMedia();
        window.location.href = "/doc_video_dashboard";
    };

</script>
<script>
    const socket = io();
    const roomId = location.pathname.split("/").pop();

    let localStream;
    let pc;

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");

    const config = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    };

    async function init() {
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });

        localVideo.srcObject = localStream;
        socket.emit("join-room", roomId);
    }

    function createPeer() {
        pc = new RTCPeerConnection(config);

        localStream.getTracks().forEach(track =>
            pc.addTrack(track, localStream)
        );

        pc.ontrack = e => {
            remoteVideo.srcObject = e.streams[0];
        };

        pc.onicecandidate = e => {
            if (e.candidate) {
                socket.emit("signal", {
                    roomId,
                    payload: { candidate: e.candidate }
                });
            }
        };
    }

    socket.on("user-joined", async () => {
        createPeer();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.emit("signal", {
            roomId,
            payload: { offer }
        });
    });

    socket.on("signal", async payload => {
        if (!pc) createPeer();

        if (payload.offer) {
            await pc.setRemoteDescription(
                new RTCSessionDescription(payload.offer)
            );
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            socket.emit("signal", {
                roomId,
                payload: { answer }
            });
        }

        if (payload.answer) {
            await pc.setRemoteDescription(
                new RTCSessionDescription(payload.answer)
            );
        }

        if (payload.candidate) {
            await pc.addIceCandidate(
                new RTCIceCandidate(payload.candidate)
            );
        }
    });

    socket.on("call-ended", () => {
        alert("Call ended");
        cleanup();
        window.location.href = "/user_video_dashboard";
    });

    function cleanup() {
        if (pc) {
            pc.close();
            pc = null;
        }

        if (localStream) {
            localStream.getTracks().forEach(t => t.stop());
            localStream = null;
        }

        localVideo.srcObject = null;
        remoteVideo.srcObject = null;
    }

    init();
</script>

</body>

</html>