<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>User Video Call</title>
</head>

<body>

    <h2>User Video Call</h2>

    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const roomId = location.pathname.split("/").pop();

        let localStream, pc;

        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");

        const config = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };

        async function init() {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });

            localVideo.srcObject = localStream;
            socket.emit("join-room", roomId);
        }

        function createPeer() {
            pc = new RTCPeerConnection(config);

            localStream.getTracks().forEach(track =>
                pc.addTrack(track, localStream)
            );

            pc.ontrack = e => {
                remoteVideo.srcObject = e.streams[0];
            };

            pc.onicecandidate = e => {
                if (e.candidate) {
                    socket.emit("signal", {
                        roomId,
                        data: { candidate: e.candidate }
                    });
                }
            };
        }

        socket.on("signal", async ({ offer, answer, candidate }) => {
            if (!pc) createPeer();

            if (offer) {
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const ans = await pc.createAnswer();
                await pc.setLocalDescription(ans);

                socket.emit("signal", {
                    roomId,
                    data: { answer: ans }
                });
            }

            if (answer) {
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
            }

            if (candidate) {
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            }
        });

        socket.on("call-ended", () => {
            alert("Doctor ended the call");
            cleanup();
            window.location.href = "/user_video_dashboard";
        });

        function cleanup() {
            if (pc) pc.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
        }

        init();
    </script>

</body>

</html>