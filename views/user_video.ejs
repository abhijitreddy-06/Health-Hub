<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Video Call | TeleHealth</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Poppins, sans-serif;
        }

        body {
            background: #000;
            overflow: hidden;
        }

        #remoteVideo {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        #localVideo {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #38bdf8;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 14px;
        }

        .controls button {
            padding: 12px 18px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            background: #1e293b;
            color: #fff;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>

    <div class="controls">
        <button id="toggleMic">Mic</button>
        <button id="toggleCam">Cam</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const ROOM_ID = "<%= roomId %>";

        let pc, localStream;
        let micOn = true, camOn = true;

        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");

        const config = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };

        async function init() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            socket.emit("join-room", ROOM_ID);
        }

        function createPeer() {
            pc = new RTCPeerConnection(config);
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
            pc.onicecandidate = e => e.candidate && socket.emit("signal", {
                roomId: ROOM_ID,
                payload: { candidate: e.candidate }
            });
        }

        socket.on("user-joined", async () => {
            createPeer();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit("signal", { roomId: ROOM_ID, payload: { offer } });
        });

        socket.on("signal", async payload => {
            if (!pc) createPeer();

            if (payload.offer) {
                await pc.setRemoteDescription(new RTCSessionDescription(payload.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit("signal", { roomId: ROOM_ID, payload: { answer } });
            }

            if (payload.answer)
                await pc.setRemoteDescription(new RTCSessionDescription(payload.answer));

            if (payload.candidate)
                await pc.addIceCandidate(new RTCIceCandidate(payload.candidate));
        });

        toggleMic.onclick = () => {
            micOn = !micOn;
            localStream.getAudioTracks()[0].enabled = micOn;
        };

        toggleCam.onclick = () => {
            camOn = !camOn;
            localStream.getVideoTracks()[0].enabled = camOn;
        };

        socket.on("call-ended", () => {
            cleanup();
            alert("Doctor ended the call");
            window.location.href = "/user_video_dashboard";
        });

        function cleanup() {
            if (pc) pc.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
        }

        init();
    </script>

</body>

</html>